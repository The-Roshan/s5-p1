<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Faculty Dashboard - Attendance System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    /* Faculty Dashboard Styling */
    .faculty-nav {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
    }

    .faculty-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px 20px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
    }

    .faculty-header h2 {
      margin: 0 0 10px 0;
      font-weight: 700;
      font-size: 28px;
    }

    .faculty-header p {
      margin: 0;
      opacity: 0.95;
      font-size: 14px;
    }

    .stat-box {
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      height: 100%;
      background: white;
      overflow: hidden;
    }

    .stat-box:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .stat-box .card-body {
      padding: 25px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #667eea;
      margin: 10px 0;
    }

    .stat-label {
      font-size: 13px;
      color: #999;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 1px;
    }

    .stat-icon {
      font-size: 28px;
      margin-bottom: 10px;
    }

    .section-card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      margin-bottom: 30px;
      border-left: 5px solid #667eea;
    }

    .section-card .card-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
      border-radius: 12px 12px 0 0;
      border: none;
    }

    .assignment-item {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      transition: all 0.3s ease;
      background: white;
    }

    .assignment-item:hover {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
      transform: translateX(5px);
    }

    .assignment-code {
      font-weight: 700;
      color: #667eea;
      font-size: 14px;
    }

    .assignment-name {
      font-size: 15px;
      margin: 5px 0;
      color: #333;
    }

    .assignment-meta {
      font-size: 12px;
      color: #999;
      margin-top: 8px;
    }

    .btn-primary-grad {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
    }

    .btn-primary-grad:hover {
      background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .badge-custom {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
    }

    .badge-section {
      background: #e3f2fd;
      color: #1976d2;
    }

    .badge-semester {
      background: #f3e5f5;
      color: #7b1fa2;
    }

    .table-enhanced thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .table-enhanced tbody tr:hover {
      background: #f5f5f5;
    }

    .form-group-enhanced {
      margin-bottom: 20px;
    }

    .form-group-enhanced label {
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    .form-control-enhanced {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px 15px;
      transition: all 0.3s ease;
    }

    .form-control-enhanced:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    .alert-custom {
      border-radius: 8px;
      border-left: 4px solid;
      padding: 15px;
    }

    .quick-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .metric-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      border: 1px solid #e0e0e0;
      transition: all 0.3s ease;
    }

    .metric-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    .metric-number {
      font-size: 36px;
      font-weight: 700;
      color: #667eea;
      margin: 10px 0;
    }

    .metric-label {
      font-size: 12px;
      color: #999;
      text-transform: uppercase;
      font-weight: 600;
    }

    /* Student Card Styles for Attendance */
    .student-attendance-card {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 15px;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .student-attendance-card:hover {
      border-color: #667eea;
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.15);
      transform: translateY(-3px);
    }

    .student-attendance-card.present {
      border-color: #4caf50;
      background: #f1f8f4;
    }

    .student-attendance-card.absent {
      border-color: #f44336;
      background: #fdf1f0;
    }

    .student-attendance-card.late {
      border-color: #ff9800;
      background: #fff9f1;
    }

    .student-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .student-rollno {
      font-weight: 700;
      color: #667eea;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .student-name {
      font-weight: 600;
      color: #333;
      font-size: 15px;
      margin: 5px 0;
    }

    .student-status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 15px;
      font-size: 11px;
      font-weight: 600;
      margin-top: 8px;
      margin-right: 5px;
    }

    .status-present {
      background: #4caf50;
      color: white;
    }

    .status-absent {
      background: #f44336;
      color: white;
    }

    .status-late {
      background: #ff9800;
      color: white;
    }

    .status-excused {
      background: #2196f3;
      color: white;
    }

    .student-form-group {
      margin-top: 12px;
    }

    .student-form-group label {
      font-size: 12px;
      font-weight: 600;
      color: #666;
      display: block;
      margin-bottom: 5px;
    }

    .student-form-group select {
      width: 100%;
      padding: 6px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
      transition: border-color 0.3s ease;
    }

    .student-form-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.1);
    }

    .student-form-group input {
      width: 100%;
      padding: 6px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 12px;
      transition: border-color 0.3s ease;
    }

    .student-form-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.1);
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark faculty-nav" id="headerNav">
    <div class="container-fluid">
      <button class="btn btn-sm btn-outline-light d-md-none me-2" onclick="document.getElementById('sidebar').classList.toggle('show')">‚ò∞</button>
      <a class="navbar-brand fw-bold" href="#">üìö Faculty Dashboard</a>
      <div class="ms-auto d-flex align-items-center gap-2">
        <button class="btn btn-outline-light btn-sm" onclick="toggleTheme()" title="Toggle Theme">üåì</button>
        <div class="navbar-nav" id="userInfo"></div>
      </div>
    </div>
  </nav>

  <div class="d-flex">
    <div class="sidebar bg-light p-3 vh-100" id="sidebar" style="width: 250px; position: fixed; overflow-y: auto; box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);"></div>
    <main class="flex-grow-1 p-4" style="margin-left: 250px; background: #f8f9fa; min-height: 100vh;">

      <!-- Dashboard Section -->
      <div id="facultyDash" class="section">
        <div class="faculty-header">
          <h2>üëã Welcome back, <span id="facName">Faculty</span>!</h2>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; font-size: 13px;">
            <div>
              <p style="margin: 0 0 3px 0;"><strong>üìß Email:</strong> <span id="facEmail">faculty1@college.edu</span></p>
              <p style="margin: 0;"><strong>üì± Contact:</strong> <span id="facContact">098-765-4321</span></p>
            </div>
            <div>
              <p style="margin: 0 0 3px 0;"><strong>üè¢ Department:</strong> <span id="facDept">Computer Science</span></p>
              <p style="margin: 0;"><strong>üëî Designation:</strong> <span id="facDesignation">Assistant Professor</span></p>
            </div>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="quick-stats">
          <div class="metric-card">
            <div class="stat-icon">üìö</div>
            <div class="metric-label">Assigned Subjects</div>
            <div class="metric-number" id="assignedSubs">0</div>
          </div>
          <div class="metric-card">
            <div class="stat-icon">üìÖ</div>
            <div class="metric-label">This Week Sessions</div>
            <div class="metric-number" id="weekSessions">0</div>
          </div>
          <div class="metric-card">
            <div class="stat-icon">üë•</div>
            <div class="metric-label">Total Students</div>
            <div class="metric-number" id="totalStudents">0</div>
          </div>
          <div class="metric-card">
            <div class="stat-icon">‚úÖ</div>
            <div class="metric-label">Avg Attendance %</div>
            <div class="metric-number" id="avgAtt">0%</div>
          </div>
        </div>

        <!-- Comprehensive Assignment Details Section -->
        <div class="section-card">
          <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h5 class="mb-0">üìñ Your Teaching Assignments</h5>
            <small style="opacity: 0.9;">Click cards for more details</small>
          </div>
          <div class="card-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;" id="assignedList"></div>
          </div>
        </div>

        <!-- Course & Section Information -->
        <div class="section-card">
          <div class="card-header">
            <h5 class="mb-0">üìä Course & Section Overview</h5>
          </div>
          <div class="card-body">
            <div id="courseOverviewContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;"></div>
          </div>
        </div>

        <!-- All Available Information Panel -->
        <div class="section-card">
          <div class="card-header">
            <h5 class="mb-0">‚ÑπÔ∏è System Information Reference</h5>
          </div>
          <div class="card-body">
            <ul class="nav nav-tabs mb-3" id="infoTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="subjectsTab-tab" data-bs-toggle="tab" data-bs-target="#subjectsTab" type="button" role="tab">All Subjects</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="coursesTab-tab" data-bs-toggle="tab" data-bs-target="#coursesTab" type="button" role="tab">All Courses</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="departmentsTab-tab" data-bs-toggle="tab" data-bs-target="#departmentsTab" type="button" role="tab">Departments</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="sectionsTab-tab" data-bs-toggle="tab" data-bs-target="#sectionsTab" type="button" role="tab">All Sections</button>
              </li>
            </ul>
            <div class="tab-content" id="infoTabContent">
              <div class="tab-pane fade show active" id="subjectsTab" role="tabpanel">
                <div class="table-responsive">
                  <table class="table table-sm table-hover">
                    <thead>
                      <tr style="background: #f8f9fa;">
                        <th>Code</th>
                        <th>Subject Name</th>
                        <th>Course</th>
                        <th>Semester</th>
                      </tr>
                    </thead>
                    <tbody id="allSubjectsBody"></tbody>
                  </table>
                </div>
              </div>
              <div class="tab-pane fade" id="coursesTab" role="tabpanel">
                <div class="table-responsive">
                  <table class="table table-sm table-hover">
                    <thead>
                      <tr style="background: #f8f9fa;">
                        <th>Course Code</th>
                        <th>Course Name</th>
                        <th>Department</th>
                        <th>Total Semesters</th>
                      </tr>
                    </thead>
                    <tbody id="allCoursesBody"></tbody>
                  </table>
                </div>
              </div>
              <div class="tab-pane fade" id="departmentsTab" role="tabpanel">
                <div class="table-responsive">
                  <table class="table table-sm table-hover">
                    <thead>
                      <tr style="background: #f8f9fa;">
                        <th>Department</th>
                        <th>Description</th>
                        <th>Courses</th>
                      </tr>
                    </thead>
                    <tbody id="allDepartmentsBody"></tbody>
                  </table>
                </div>
              </div>
              <div class="tab-pane fade" id="sectionsTab" role="tabpanel">
                <div style="display: flex; flex-wrap: wrap; gap: 10px;" id="allSectionsContainer"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="section-card">
          <div class="card-header">
            <h5 class="mb-0">‚ö° Quick Actions</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <button class="btn btn-primary-grad w-100" onclick="showSection('takeAttendance')">
                  <span style="font-size: 18px;">üìù</span> Take Attendance
                </button>
              </div>
              <div class="col-md-6 mb-3">
                <button class="btn btn-primary-grad w-100" onclick="showSection('viewAttendance')">
                  <span style="font-size: 18px;">üëÅÔ∏è</span> View/Edit Attendance
                </button>
              </div>
              <div class="col-md-6 mb-3">
                <button class="btn btn-primary-grad w-100" onclick="showSection('facultyReports')">
                  <span style="font-size: 18px;">üìä</span> Generate Reports
                </button>
              </div>
              <div class="col-md-6 mb-3">
                <button class="btn btn-primary-grad w-100" onclick="showSection('facultyProfile')">
                  <span style="font-size: 18px;">üë§</span> My Profile
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Faculty Profile Section -->
      <div id="facultyProfile" class="section" style="display:none;">
        <div class="section-card">
          <div class="card-header">
            <h5 class="mb-0">üë§ Faculty Profile</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <p><strong>Name:</strong> <span id="profName">-</span></p>
                <p><strong>Email:</strong> <span id="profEmail">-</span></p>
                <p><strong>Contact:</strong> <span id="profContact">-</span></p>
              </div>
              <div class="col-md-6">
                <p><strong>Department:</strong> <span id="profDept">-</span></p>
                <p><strong>Employee ID:</strong> <span id="profId">-</span></p>
                <p><strong>Subjects Teaching:</strong> <span id="profSubCount">0</span></p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Take Attendance Section -->
      <div id="takeAttendance" class="section" style="display:none;">
        <div class="section-card">
          <div class="card-header">
            <h5 class="mb-0">üìù Mark Attendance</h5>
          </div>
          <div class="card-body">
            <!-- Selected Subject Info Panel -->
            <div id="selectedSubjectInfo" style="display:none; background: #f0f4ff; border-left: 4px solid #667eea; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
              <h6 style="margin: 0 0 10px 0; color: #667eea;">‚ÑπÔ∏è Selected Subject Details</h6>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 13px;">
                <div><strong>Subject Code:</strong> <span id="displaySubCode">-</span></div>
                <div><strong>Subject Name:</strong> <span id="displaySubName">-</span></div>
                <div><strong>Course:</strong> <span id="displayCourse">-</span></div>
                <div><strong>Section:</strong> <span id="displaySection">-</span></div>
                <div><strong>Semester:</strong> <span id="displaySemester">-</span></div>
                <div><strong>Academic Year:</strong> <span id="displayYear">2025</span></div>
              </div>
            </div>

            <form id="attendanceForm" class="mb-4">
              <div class="row">
                <div class="col-md-5">
                  <div class="form-group-enhanced">
                    <label for="subjectSelect"><strong>üìö Select Subject *</strong></label>
                    <select class="form-control form-control-enhanced" id="subjectSelect" onchange="showSelectedSubjectInfo()" required>
                      <option value="">-- Choose Subject to Mark Attendance --</option>
                    </select>
                    <small style="color: #999; margin-top: 5px; display: block;">Shows all subjects you are assigned</small>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-group-enhanced">
                    <label for="attDate"><strong>üìÖ Attendance Date *</strong></label>
                    <input type="date" class="form-control form-control-enhanced" id="attDate" value="2025-12-09" required>
                    <small style="color: #999; margin-top: 5px; display: block;">Select date for attendance</small>
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="form-group-enhanced">
                    <label for="period"><strong>üïê Period (1-6) *</strong></label>
                    <input type="number" class="form-control form-control-enhanced" id="period" placeholder="1-6" min="1" max="6" required>
                    <small style="color: #999; margin-top: 5px; display: block;">Period number</small>
                  </div>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                  <button type="submit" class="btn btn-primary-grad w-100" onclick="createAttendanceSession(event); return false;">
                    <span>üìã</span> Create Session
                  </button>
                </div>
              </div>
            </form>

            <div id="studentList" style="display:none;">
              <div class="alert-custom" style="background: #e3f2fd; border-color: #1976d2; color: #1976d2; margin-bottom: 20px;">
                <strong>üìå Marking Attendance</strong> - Select status for each student and click Save. Students in this section: <span id="totalStudentsDisplay">0</span>
              </div>
              <div class="btn-group mb-3" role="group">
                <button type="button" class="btn btn-success" onclick="markAll('Present')">‚úÖ Mark All Present</button>
                <button type="button" class="btn btn-danger" onclick="markAll('Absent')">‚ùå Mark All Absent</button>
                <button type="button" class="btn btn-warning" onclick="markAll('Late')">üïê Mark All Late</button>
              </div>
              
              <!-- Enhanced Student Cards View -->
              <div id="studentCardsContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin-bottom: 20px;"></div>
              
              <!-- Table View Toggle -->
              <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleTableView()">üìä Switch to Table View</button>
                <button type="button" class="btn btn-outline-info btn-sm" onclick="refreshCardStatus()">üîÑ Refresh</button>
              </div>

              <!-- Table View (Hidden by default) -->
              <div id="tableViewContainer" style="display:none;">
                <div class="table-responsive">
                  <table class="table table-enhanced table-hover">
                    <thead>
                      <tr>
                        <th>Roll No</th>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Remark</th>
                      </tr>
                    </thead>
                    <tbody id="attStudentsTbody"></tbody>
                  </table>
                </div>
              </div>
              
              <button type="button" id="saveAttendance" class="btn btn-primary-grad btn-lg w-100">üíæ Save Attendance</button>
            </div>
          </div>
        </div>
      </div>

      <!-- View/Edit Attendance Section -->
      <div id="viewAttendance" class="section" style="display:none;">
        <div class="section-card">
          <div class="card-header">
            <h5 class="mb-0">üëÅÔ∏è View & Edit Attendance</h5>
          </div>
          <div class="card-body">
            <div class="row mb-4">
              <div class="col-md-3">
                <label for="viewSubSelect" class="form-label">Subject</label>
                <select class="form-control form-control-enhanced" id="viewSubSelect">
                  <option value="">All Subjects</option>
                </select>
              </div>
              <div class="col-md-3">
                <label for="viewFrom" class="form-label">From Date</label>
                <input type="date" class="form-control form-control-enhanced" id="viewFrom">
              </div>
              <div class="col-md-3">
                <label for="viewTo" class="form-label">To Date</label>
                <input type="date" class="form-control form-control-enhanced" id="viewTo">
              </div>
              <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-primary-grad w-100" onclick="loadViewAttendance()">üîç Filter</button>
              </div>
            </div>
            <div id="viewOutput"></div>
          </div>
        </div>
      </div>

      <!-- Reports Section -->
      <div id="facultyReports" class="section" style="display:none;">
        <div class="section-card">
          <div class="card-header">
            <h5 class="mb-0">üìä Faculty Reports</h5>
          </div>
          <div class="card-body">
            <div class="row mb-4">
              <div class="col-md-4">
                <label for="reportSub" class="form-label">Select Subject</label>
                <select class="form-control form-control-enhanced" id="reportSub">
                  <option value="">All Subjects</option>
                </select>
              </div>
              <div class="col-md-4 d-flex align-items-end">
                <button class="btn btn-primary-grad w-100" onclick="generateFacultyReport()">üìà Generate Report</button>
              </div>
            </div>
            <div id="facReportOutput"></div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <footer class="bg-dark text-white text-center py-3 mt-5">
    <p>&copy; 2025 College Attendance System v1.0</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <div id="globalSpinner" style="display:none;"></div>
  <script src="script.js" defer></script>
  <script>
    let currentSessionId;
    let currentStudents = [];

    document.addEventListener('DOMContentLoaded', function() {
      // Small delay to ensure script.js data is loaded
      setTimeout(function() {
        const user = getCurrentUser();
        if (!user || user.role !== 'faculty') window.location.href = 'index.html';
        updateHeader();
        buildSidebar('faculty');
        showSection('facultyDash');
        loadSectionContent('facultyDash');
        
        document.getElementById('attendanceForm').addEventListener('submit', createAttendanceSession);
        document.getElementById('saveAttendance').addEventListener('click', saveAttendance);
      }, 100);
    });

    function loadSectionContent(sectionId) {
      const user = getCurrentUser();
      const fac = data.faculty.find(f => f.userId === user.id);
      
      if (!fac) {
        console.error('Faculty not found');
        fac = { id: 1, name: 'Jane Smith', userId: user.id, email: 'fac@college.edu', contact: '123-456-7890' };
      }
      
      // Display faculty info
      document.getElementById('facName').textContent = fac.name || 'Faculty';
      document.getElementById('facEmail').textContent = 'üìß Email: ' + (fac.email || 'faculty@college.edu');
      
      if (sectionId === 'facultyDash') {
        const allocations = data.allocations.filter(a => a.facultyId === fac.id);
        document.getElementById('assignedSubs').textContent = allocations.length;
        
        // Week sessions
        const now = new Date();
        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        const weekSessions = data.attendanceSessions.filter(s => {
          const sesDate = new Date(s.date);
          return sesDate >= weekAgo && data.allocations.find(a => a.id === s.allocationId && a.facultyId === fac.id);
        }).length;
        document.getElementById('weekSessions').textContent = weekSessions;
        
        // Total students
        const allStudents = new Set();
        allocations.forEach(alloc => {
          const courseStudents = data.students.filter(s => 
            s.courseId === data.subjects.find(sub => sub.id === alloc.subjectId)?.courseId &&
            s.semester === alloc.semester &&
            s.section === alloc.section
          );
          courseStudents.forEach(st => allStudents.add(st.id));
        });
        document.getElementById('totalStudents').textContent = allStudents.size;
        
        // Average attendance
        let totalPerc = 0, count = 0;
        allocations.forEach(alloc => {
          const sessions = data.attendanceSessions.filter(s => s.allocationId === alloc.id);
          if (sessions.length) {
            let attended = 0;
            data.attendanceDetails.forEach(d => {
              if (sessions.some(s => s.id === d.sessionId) && d.status === 'Present') attended++;
            });
            totalPerc += (attended / sessions.length) * 100;
            count++;
          }
        });
        document.getElementById('avgAtt').textContent = count ? (totalPerc / count).toFixed(1) + '%' : '0%';
        
        // Display assigned subjects
        const list = document.getElementById('assignedList');
        list.innerHTML = allocations.map(a => {
          const sub = data.subjects.find(s => s.id === a.subjectId);
          return `
            <div class="assignment-item">
              <div class="assignment-code">${sub?.code || 'N/A'}</div>
              <div class="assignment-name">${sub?.name || 'Unknown Subject'}</div>
              <div class="assignment-meta">
                <span class="badge badge-custom badge-section">Section ${a.section}</span>
                <span class="badge badge-custom badge-semester">Sem ${a.semester}</span>
                <span class="badge badge-info">Year ${a.academicYear || '2025'}</span>
              </div>
            </div>
          `;
        }).join('');
      } else if (sectionId === 'facultyProfile') {
        document.getElementById('profName').textContent = fac.name || '-';
        document.getElementById('profEmail').textContent = fac.email || '-';
        document.getElementById('profContact').textContent = fac.contact || '-';
        const dept = data.departments.find(d => d.id === 1);
        document.getElementById('profDept').textContent = dept?.name || 'Computer Science';
        document.getElementById('profId').textContent = 'FAC00' + fac.id;
        const allocations = data.allocations.filter(a => a.facultyId === fac.id);
        document.getElementById('profSubCount').textContent = allocations.length;
      } else if (sectionId === 'takeAttendance') {
        const allocations = data.allocations.filter(a => a.facultyId === fac.id);
        const select = document.getElementById('subjectSelect');
        select.innerHTML = '<option value="">Select Subject</option>' + allocations.map(a => {
          const sub = data.subjects.find(s => s.id === a.subjectId);
          return `<option value="${a.id}">${sub?.code} - ${sub?.name} (Section ${a.section})</option>`;
        }).join('');
      } else if (sectionId === 'viewAttendance' || sectionId === 'facultyReports') {
        const allocations = data.allocations.filter(a => a.facultyId === fac.id);
        const subSelect = document.getElementById(sectionId === 'viewAttendance' ? 'viewSubSelect' : 'reportSub');
        subSelect.innerHTML = '<option value="">All Subjects</option>' + allocations.map(a => {
          const sub = data.subjects.find(s => s.id === a.subjectId);
          return `<option value="${a.id}">${sub?.name}</option>`;
        }).join('');
      }
    }

    function createAttendanceSession(e) {
      e.preventDefault();
      const allocId = parseInt(document.getElementById('subjectSelect').value);
      const date = document.getElementById('attDate').value;
      const period = parseInt(document.getElementById('period').value);
      
      if (!allocId || !date || !period) return alert('All fields required');
      
      const existing = data.attendanceSessions.find(s => s.allocationId === allocId && s.date === date && s.period === period);
      if (existing) return alert('Attendance already taken for this session!');
      
      // Create session
      const newSession = { id: Date.now(), allocationId: allocId, date, period };
      data.attendanceSessions.push(newSession);
      saveData();
      currentSessionId = newSession.id;
      
      // Load students
      const alloc = data.allocations.find(a => a.id === allocId);
      currentStudents = data.students.filter(s => s.semester === alloc.semester && s.section === alloc.section);
      
      // Generate student cards
      const cardsContainer = document.getElementById('studentCardsContainer');
      cardsContainer.innerHTML = currentStudents.map((s, index) => `
        <div class="student-attendance-card" id="studentCard_${index}">
          <div class="student-card-header">
            <span class="student-rollno">${s.rollNo}</span>
            <span id="statusBadge_${index}"></span>
          </div>
          <div class="student-name">${s.name}</div>
          <div class="student-form-group">
            <label>Status</label>
            <select class="statusSelect" data-student-id="${s.id}" onchange="updateCardStatus(${index})">
              <option value="">Select Status</option>
              <option value="Present">‚úÖ Present</option>
              <option value="Absent">‚ùå Absent</option>
              <option value="Late">üïê Late</option>
              <option value="Excused">‚è≥ Excused</option>
            </select>
          </div>
          <div class="student-form-group">
            <label>Remark (Optional)</label>
            <input type="text" class="remarkInput" placeholder="e.g., Medical, Leave..." data-student-id="${s.id}">
          </div>
        </div>
      `).join('');
      
      // Also generate table rows
      const tbody = document.getElementById('attStudentsTbody');
      tbody.innerHTML = currentStudents.map(s => 
        `<tr>
          <td>${s.rollNo}</td><td>${s.name}</td>
          <td><select class="form-control statusSelect" data-student-id="${s.id}"><option value="">Select</option><option value="Present">Present</option><option value="Absent">Absent</option><option value="Late">Late</option><option value="Excused">Excused</option></select></td>
          <td><input type="text" class="form-control remarkInput" placeholder="Remark" data-student-id="${s.id}"></td>
        </tr>`
      ).join('');
      
      document.getElementById('studentList').style.display = 'block';
    }

    function updateCardStatus(index) {
      const select = document.querySelectorAll('.statusSelect')[index];
      const status = select.value;
      const card = document.getElementById(`studentCard_${index}`);
      const badge = document.getElementById(`statusBadge_${index}`);
      
      // Update card style
      card.classList.remove('present', 'absent', 'late');
      if (status === 'Present') card.classList.add('present');
      else if (status === 'Absent') card.classList.add('absent');
      else if (status === 'Late') card.classList.add('late');
      
      // Update badge
      const badges = {
        'Present': '‚úÖ Present',
        'Absent': '‚ùå Absent',
        'Late': 'üïê Late',
        'Excused': '‚è≥ Excused'
      };
      badge.innerHTML = status ? `<span class="student-status-badge status-${status.toLowerCase()}">${badges[status]}</span>` : '';
    }

    function toggleTableView() {
      const cardsContainer = document.getElementById('studentCardsContainer');
      const tableContainer = document.getElementById('tableViewContainer');
      if (tableContainer.style.display === 'none') {
        tableContainer.style.display = 'block';
        cardsContainer.style.display = 'none';
      } else {
        tableContainer.style.display = 'none';
        cardsContainer.style.display = 'grid';
      }
    }

    function markAll(status) {
      document.querySelectorAll('.statusSelect').forEach((select, index) => {
        select.value = status;
        // Update card display if in cards view
        const cardsContainer = document.getElementById('studentCardsContainer');
        if (cardsContainer.style.display !== 'none') {
          updateCardStatus(index);
        }
      });
    }

    function saveAttendance() {
      let saved = 0;
      let empty = 0;
      
      currentStudents.forEach((stu, index) => {
        const statusSelect = document.querySelectorAll('.statusSelect')[index];
        const status = statusSelect.value.trim();
        const remark = document.querySelectorAll('.remarkInput')[index].value.trim();
        
        if (!status) {
          empty++;
          statusSelect.style.borderColor = '#f44336';
          return;
        }
        
        statusSelect.style.borderColor = '#ddd';
        
        // Check if exists
        const existing = data.attendanceDetails.find(d => d.sessionId === currentSessionId && d.studentId === stu.id);
        if (existing) {
          existing.status = status;
          existing.remark = remark;
        } else {
          data.attendanceDetails.push({ 
            id: Date.now() + Math.random(), 
            sessionId: currentSessionId, 
            studentId: stu.id, 
            status, 
            remark 
          });
        }
        saved++;
      });
      
      if (empty > 0) {
        alert(`‚ùå Error: ${empty} student(s) have no status selected!`);
        return;
      }
      
      saveData();
      alert(`‚úÖ Success! ${saved} attendance record(s) saved!`);
      document.getElementById('studentList').style.display = 'none';
      document.getElementById('studentCardsContainer').innerHTML = '';
      document.getElementById('attStudentsTbody').innerHTML = '';
      loadSectionContent('takeAttendance');
    }

    function loadViewAttendance() {
      const allocId = parseInt(document.getElementById('viewSubSelect').value);
      const from = document.getElementById('viewFrom').value;
      const to = document.getElementById('viewTo').value;
      if (!allocId) return alert('Select subject');
      
      const sessions = data.attendanceSessions.filter(s => s.allocationId === allocId && (!from || s.date >= from) && (!to || s.date <= to));
      let output = '<table class="table"><thead><tr><th>Date</th><th>Period</th><th>Students Present/Absent</th><th>Actions</th></tr></thead><tbody>';
      sessions.forEach(ses => {
        const details = data.attendanceDetails.filter(d => d.sessionId === ses.id);
        const present = details.filter(d => d.status === 'Present').length;
        const total = currentStudents.length; // Assume same students
        output += `<tr><td>${ses.date}</td><td>${ses.period}</td><td>${present}/${total}</td><td><button class="btn btn-sm btn-info" onclick="editSession(${ses.id})">Edit</button></td></tr>`;
      });
      output += '</tbody></table>';
      document.getElementById('viewOutput').innerHTML = output;
    }

    function editSession(sessionId) {
      // Similar to take attendance, but load existing statuses
      alert('Edit mode: Reload session and modify statuses, then save.');
      // Implement by setting currentSessionId and reloading tbody with existing values
    }

    function generateFacultyReport() {
      const allocId = parseInt(document.getElementById('reportSub').value);
      if (!allocId) return alert('Select subject');
      
      const alloc = data.allocations.find(a => a.id === allocId);
      const sub = data.subjects.find(s => s.id === alloc.subjectId);
      const students = data.students.filter(s => s.semester === alloc.semester && s.section === alloc.section);
      const sessions = data.attendanceSessions.filter(s => s.allocationId === allocId);
      const totalClasses = sessions.length;
      
      let output = `<h5>${sub.name}: Summary</h5><p>Total Classes: ${totalClasses}</p><table class="table"><thead><tr><th>Student</th><th>Attended</th><th>%</th></tr></thead><tbody>`;
      let avgAtt = 0;
      students.forEach(stu => {
        const attended = data.attendanceDetails.filter(d => 
          sessions.some(s => s.id === d.sessionId) && d.studentId === stu.id && d.status === 'Present'
        ).length;
        const perc = totalClasses ? (attended / totalClasses) * 100 : 0;
        avgAtt += perc;
        output += `<tr><td>${stu.name} (${stu.rollNo})</td><td>${attended}</td><td>${perc.toFixed(2)}%</td></tr>`;
      });
      output += `<tr class="table-info"><td>Average</td><td>-</td><td>${(avgAtt / students.length).toFixed(2)}%</td></tr></tbody></table>`;
      document.getElementById('facReportOutput').innerHTML = output;
    }
  </script>
</body>
</html>